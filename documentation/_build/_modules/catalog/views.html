

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>catalog.views &mdash; Документация Система Analog 0.2</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Алфавитный указатель" href="../../genindex.html" />
    <link rel="search" title="Поиск" href="../../search.html" /> 

</head>

<body>
    <header>
        <div class="container">
            <a class="site-nav-toggle hidden-lg-up"><i class="icon-menu"></i></a>
            <a class="site-title" href="../../index.html">
                Система Analog
            </a>
        </div>
    </header>


<div class="breadcrumbs-outer hidden-xs-down">
    <div class="container">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="breadcrumbs">
    
      <li><a href="../../index.html">Docs</a></li>
        
          <li><a href="../index.html">Код модуля</a></li>
        
      <li>catalog.views</li>
    
    
      <li class="breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
    </div>
</div>
    <div class="main-outer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-3 site-nav">
                    
<div role="search">
    <form class="search" action="../../search.html" method="get">
        <div class="icon-input">
            <input type="text" name="q" placeholder="Search" />
            <span class="icon-search"></span>
        </div>
        <input type="submit" value="Искать" class="d-hidden" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
                    <div class="site-nav-tree">
                        

                            
                            
                                <p class="caption"><span class="caption-text">Оглавление:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Система Analog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#id1">Краткое описание</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#id2">Разворачивание проекта разработчиком</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../techspec.html">Функциональные требования к Системе Analog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id1">1. Общее описание</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id2">1.1. описание процесса «как есть сейчас»</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id3">1.2. какой результат нужен</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id4">1.3. требования к ПО и разработчику</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id5">2. Описание отдельных процедур и частей алгоритма</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id6">2.1. первоначальная Загрузка и обновление БД</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id7">2.2. структура данных</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id8">2.3. какие значения могут быть у атрибута:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id9">2.4. загрзка спецификации</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id10">2.5. форма запроса</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id11">2.6. алгоритм поиска</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../techspec.html#id12">2.7. сохранение результатов</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../dettechspec.html">Проектное решение по разработке Системы Analog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id1">1. Определения, сокращения и аббревиатуры</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id2">2. Общие сведения</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id3">3. Бизнес-процессы</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id4">4. Декомпозиция архитектуры</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id5">4.1 АРМ Пользователя</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id6">4.2 АРМ Администратора</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id7">5. Сущности</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id8">5.1 прикладные сущности</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id9">5.2 Системные сущности</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id10">6. Представления</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id11">6.1 таблица/перечень</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id12">6.2 карточка экземпляра сущности</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id13">6.3 форма запроса параметров подбора спецификации-аналога</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id14">7. Группы</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id15">8. Справочники и классификаторы</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id16">9. Требования к отказоустойчивости</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dettechspec.html#id17">10. Требования к хостингу и инфраструктура хостинга</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Исходный код</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../catalog.html">catalog package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core.html">core package</a></li>
</ul>
</li>
</ul>

                            
                        
<a href="genindex.html">Алфавитный указатель</a>
<a href="py-modindex.html">Состав модулей</a>

                    </div>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="document">
                        
                            
  <h1>Исходный код catalog.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">catalog.models</span> <span class="k">import</span> <span class="n">Product</span><span class="p">,</span> <span class="n">FixedAttributeValue</span><span class="p">,</span> <span class="n">UnFixedAttributeValue</span><span class="p">,</span> <span class="n">FixedValue</span><span class="p">,</span> <span class="n">Category</span><span class="p">,</span> <span class="n">DataFile</span>
<span class="kn">from</span> <span class="nn">catalog</span> <span class="k">import</span> <span class="n">choices</span>
<span class="kn">from</span> <span class="nn">catalog.handlers</span> <span class="k">import</span> <span class="n">ProcessingSearchFile</span><span class="p">,</span> <span class="n">result_processing</span>
<span class="kn">from</span> <span class="nn">catalog.utils</span> <span class="k">import</span> <span class="n">SearchProducts</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">login_required</span>


<div class="viewcode-block" id="render_search"><a class="viewcode-back" href="../../catalog.html#catalog.views.render_search">[документация]</a><span class="k">def</span> <span class="nf">render_search</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span> <span class="n">queryset</span><span class="p">)</span></div>
<span class="c1"># Create your views here.</span>


<div class="viewcode-block" id="advanced_search_view"><a class="viewcode-back" href="../../catalog.html#catalog.views.advanced_search_view">[документация]</a><span class="k">def</span> <span class="nf">advanced_search_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">manufacturer_to</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
	<span class="c1"># be sure to rewrite form formation</span>
	<span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
	<span class="c1"># attributes = product.category.attributes.all()#.exclude(type=&#39;hrd&#39;)</span>
	<span class="n">fix_attributes</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">fixed_attrs_vals</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="c1">#category.attributes.all()</span>
	<span class="n">unfix_attributes</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">unfixed_attrs_vals</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="c1">#category.attributes.all()</span>
	<span class="c1">#attributes = product.attrs_vals.all()</span>
	<span class="c1"># attributes_array = {str(attr.pk): {&#39;title&#39;: attr.title,</span>
	<span class="c1">#                                    &#39;type_display&#39;: attr.get_type_display(),</span>
	<span class="c1">#                                    &#39;attribute&#39;: attr,</span>
	<span class="c1">#                                    &#39;type&#39;: attr.type} for attr in attributes}</span>
	<span class="n">attributes_array</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s1">&#39;fix&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">pk</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">&#39;type_display&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">get_type_display</span><span class="p">(),</span>
	                       <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="n">FixedValue</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">),</span>
	                       <span class="c1"># &#39;choices&#39;: [attribute.title for attribute in FixedValue.objects.filter(attribute=attr.attribute)],</span>
	                       <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span><span class="p">}</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fix_attributes</span><span class="p">}</span>
	
	<span class="n">fix_attributes_array</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fix&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">pk</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
	                                   <span class="s1">&#39;type_display&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">get_type_display</span><span class="p">(),</span>
	                                       <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="n">FixedValue</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">),</span>
	                                        <span class="c1"># &#39;choices&#39;: [attribute.title for attribute in FixedValue.objects.filter(attribute=attr.attribute)],</span>
	                                   <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span><span class="p">}</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fix_attributes</span><span class="p">}</span>
	
	<span class="n">unfix_attributes_array</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s1">&#39;unfix&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">pk</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">&#39;type_display&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">get_type_display</span><span class="p">(),</span>
		                         <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="n">TYPES_SEARCH</span><span class="p">,</span>
		                         <span class="c1"># &#39;choices&#39;: [attribute.title for attribute in FixedValue.objects.filter(attribute=attr.attribute)],</span>
		                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">type</span><span class="p">}</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unfix_attributes</span><span class="p">}</span>
	
	<span class="n">attributes_array</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fix_attributes_array</span><span class="p">)</span>
	<span class="n">attributes_array</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">unfix_attributes_array</span><span class="p">)</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">article</span><span class="p">}</span>
	<span class="n">advanced_form</span> <span class="o">=</span> <span class="n">AdvancedSearchForm</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="n">attributes_array</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
	<span class="c1"># advanced_form = AdvancedSearchForm(extra=attributes_array, initial=data)</span>
	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
		<span class="n">advanced_form</span> <span class="o">=</span> <span class="n">AdvancedSearchForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">attributes_array</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">advanced_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
			<span class="n">advanced_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;manufacturer_from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">manufacturer</span>
			<span class="n">advanced_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;manufacturer_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manufacturer_to</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">SearchProducts</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">advanced_form</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result_processing</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			
	<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/advanced_search.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;advanced_form&#39;</span><span class="p">:</span> <span class="n">advanced_form</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">,</span>
	                                                              <span class="s1">&#39;manufacturer_to&#39;</span><span class="p">:</span> <span class="n">manufacturer_to</span><span class="p">})</span><span class="c1">#, {&#39;advanced_form&#39;: advanced_form})</span></div>


<div class="viewcode-block" id="search_view"><a class="viewcode-back" href="../../catalog.html#catalog.views.search_view">[документация]</a><span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s1">&#39;/admin/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">search_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="n">form</span> <span class="o">=</span> <span class="n">SearchForm</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
		<span class="n">form</span> <span class="o">=</span> <span class="n">SearchForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
			<span class="n">advanced_search</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;advanced_search&#39;</span><span class="p">]</span>
			<span class="n">article</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;article&#39;</span><span class="p">]</span>
			<span class="n">manufacturer_from</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;manufacturer_from&#39;</span><span class="p">]</span>
			<span class="n">manufacturer_to</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;manufacturer_to&#39;</span><span class="p">]</span>
			
			<span class="k">try</span><span class="p">:</span>
				<span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">article</span><span class="o">=</span><span class="n">article</span><span class="p">,</span> <span class="n">manufacturer</span><span class="o">=</span><span class="n">manufacturer_from</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">Product</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span>
				              <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Не найден продукт с артикулом </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">article</span><span class="p">)}})</span>
			<span class="k">except</span> <span class="n">Product</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span>
				              <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Найдено более одного продукта с артикулом </span><span class="si">{}</span><span class="s1">&#39;</span>
				                                             <span class="s1">&#39;и производителем </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">manufacturer_from</span><span class="p">)}})</span>
			
			<span class="k">if</span> <span class="n">advanced_search</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;catalog:advanced_search&#39;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">manufacturer_to</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">SearchProducts</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result_processing</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="c1"># return SearchProducts(request, form, product).search()</span>

		<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Ошибка формы&#39;</span><span class="p">}})</span>

	<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>


<div class="viewcode-block" id="search_from_file_view"><a class="viewcode-back" href="../../catalog.html#catalog.views.search_from_file_view">[документация]</a><span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s1">&#39;/admin/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">search_from_file_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
		<span class="n">form</span> <span class="o">=</span> <span class="n">SearchFromFile</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
			<span class="n">instance</span> <span class="o">=</span> <span class="n">DataFile</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">],</span>
			                    <span class="nb">type</span><span class="o">=</span><span class="n">choices</span><span class="o">.</span><span class="n">TYPES_FILE</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
			                    <span class="n">created_by</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
			                    <span class="n">updated_by</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
			<span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
			<span class="n">file_response</span> <span class="o">=</span> <span class="n">ProcessingSearchFile</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">],</span> <span class="n">instance</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">csv_processing</span><span class="p">()</span>
			
			<span class="c1"># return file</span>
			<span class="c1"># file_path = instance.file.path</span>
			<span class="c1"># if os.path.exists(file_path):</span>
			<span class="c1"># 	with open(file_path, &#39;rb&#39;) as fh:</span>
			<span class="c1"># 		response = HttpResponse(fh.read(), content_type=&quot;application/vnd.ms-excel&quot;)</span>
			<span class="c1"># 		response[&#39;Content-Disposition&#39;] = &#39;inline; filename=&#39; + os.path.basename(file_path)</span>
			<span class="c1"># 		return response</span>
			<span class="c1"># raise Http404</span>
		
			<span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">file_response</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
			<span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&#39;</span> <span class="o">+</span> <span class="n">file_response</span><span class="o">.</span><span class="n">name</span> <span class="c1">#&#39;{}/{}&#39;.format(settings.FILES_ROOT, file_response.name) #file_response.path</span>
			<span class="k">return</span> <span class="n">response</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">form</span> <span class="o">=</span> <span class="n">SearchFromFile</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;admin/catalog/search.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;file_form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>
</pre></div>

                        
                    </div>
                </div>
            </div>
        </div>
    </div>    


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2',
            LANGUAGE:'ru',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  
    <div class="footer" role="contentinfo">
        <div class="container">
            &#169; Copyright 2019, Vladislav Sazonov &amp; Alexander Tseluyko.
        Создано с помощью <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
        </div>
    </div>  

</body>
</html>